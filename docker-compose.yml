version: '3.1'

services:
    nginx:
        restart: always
        image: nginx:1.15.4
        ports:
            - ${NGINX_HTTP_PORT}:80
            - ${NGINX_SSL_PORT}:443
        volumes:
            # Монтируем папку приложения, в том числе недоступные из веба файлы:
            - ./www/:/var/www/:Z
            # Подключим файл конфига Nginx:
            - ./.docker_build_configs/nginx/default.conf:/etc/nginx/conf.d/default.conf:Z
            # Mount Nginx logs:
            - ./logs/nginx/:/var/log/nginx/nginx_file_logs/:Z
        links:
            - phpfpm

    phpfpm:
        restart: always
        build:
            context: .
            dockerfile: ./.docker_build_configs/php_fpm/Dockerfile
            args:
                CONTAINER_TIMEZONE_PHPFPM: ${CONTAINER_TIMEZONE_PHPFPM}
        volumes:
            # Монтируем папку приложения, в том числе недоступные из веба файлы:
            - ./www:/var/www/:Z
            # Изменяем некоторые значения в php.ini:
            - ./.docker_build_configs/php_fpm/my_extra_php.ini:/usr/local/etc/php/conf.d/my_extra_php.ini:Z
        links:
            - mysql

    mysql:
        restart: always
        #image: mysql:8.0.12
        image: mysql:5.7
        ports:
            - ${MYSQL_PORT}:3306
        environment:
            MYSQL_DATABASE: ${MYSQL_DATABASE}
            MYSQL_USER: ${MYSQL_USER}
            MYSQL_PASSWORD: ${MYSQL_PASSWORD}
            MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
        volumes:
            # Зададим дополнительные настройки mysql:
            - ./.docker_build_configs/mysql/mysql.cnf:/etc/mysql/conf.d/mysql.cnf:Z
            # Зальем первоначальный дамп таблиц:
            #- ./.docker_build_configs/mysql/mysql_init_db_strurture:/docker-entrypoint-initdb.d:Z
            # Монтируем файлы mysql на хост, чтобы они не уничтожались пре перезапуске контейнера.
            #- ./mysql_files:/var/lib/mysql:Z
            # Mount mysql logs:
            - ./logs/mysql/:/var/log/mysql/:Z

    phpmyadmin:
        restart: always
        image: phpmyadmin/phpmyadmin:4.7
        ports:
            - ${PHPMYADMIN_PORT}:80
        volumes:
            # Зададим некоторые свои настройки phpmyadmin:
            - ./.docker_build_configs/phpmyadmin/config.user.inc.php:/etc/phpmyadmin/config.user.inc.php:Z
        environment:
            #MYSQL_USER: ${MYSQL_USER}
            #MYSQL_PASSWORD: ${MYSQL_PASSWORD}
            MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
        links: 
            - mysql:db
            
    cron:
        restart: always
        build:
            context: .
            dockerfile: ./.docker_build_configs/cron/Dockerfile
            args:
                CONTAINER_TIMEZONE_CRON: ${CONTAINER_TIMEZONE_CRON}
        volumes:
            # Монтируем папку приложения, в том числе недоступные из веба файлы:
            - ./www/:/var/www/:Z
            # Mount cron output logs:
            - ./logs/cron_output/:/var/log/cron/:Z
        links:
            - phpfpm

volumes:
    persistent:
